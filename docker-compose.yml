version: '3.8'

# This file defines the multi-container application setup for CI/CD deployment.
# It now includes the backend, a dedicated scheduler for background jobs, and Redis.
# Images are pulled from a container registry, and secrets are injected by Doppler.

services:
  # 1. The main web application service
  backend:
    image: ${DOCKERHUB_USERNAME}/feelori-backend:${IMAGE_TAG:-latest}
    container_name: feelori_backend
    restart: unless-stopped
    ports:
      - "127.0.0.1:8000:8000"
    command: gunicorn -w 2 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000 -t 120 app.main:app
    depends_on:
      - redis
    networks:
      - feelori-net

  # 2. The new dedicated scheduler service
  # This service runs all background and periodic tasks (e.g., analytics, reminders).
  scheduler:
    image: ${DOCKERHUB_USERNAME}/feelori-backend:${IMAGE_TAG:-latest}
    container_name: feelori_scheduler
    restart: unless-stopped
    # This command runs our new scheduler script.
    command: python scheduler.py
    depends_on:
      - redis
    networks:
      - feelori-net

  # 3. The dedicated ML worker is disabled to save memory.
  # To re-enable it in the future, simply uncomment the lines below.
  # ml_worker:
  #   image: ${DOCKERHUB_USERNAME}/feelori-backend:${IMAGE_TAG:-latest}
  #   container_name: feelori_ml_worker
  #   restart: unless-stopped
  #   command: python ml_worker.py
  #   depends_on:
  #     - redis
  #   networks:
  #     - feelori-net
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 4G

  # 4. The Redis service for caching and queuing
  redis:
    image: "redis:7-alpine"
    container_name: feelori_redis
    restart: unless-stopped
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - feelori-net

# Define a volume to persist Redis data across container restarts
volumes:
  redis-data:

# Define a shared network for all services to communicate
networks:
  feelori-net: