version: '3.8'

# Multi-container setup for CI/CD deployment
# Includes backend, scheduler, Redis.
# Secrets are injected by Doppler via GitHub Actions (not inside this file).

services:
  # 1. The main web application service
  backend:
    image: ${DOCKERHUB_USERNAME}/feelori-backend:${IMAGE_TAG:-latest}
    container_name: feelori_backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    command: gunicorn -w 2 -k uvicorn.workers.UvicornWorker -b 0.0.0.0:8000 -t 120 --forwarded-allow-ips '*' --proxy-protocol app.main:app
    depends_on:
      - redis
    networks:
      - feelori-net
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - API_KEY=${API_KEY}
      #- CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - ENVIRONMENT=${ENVIRONMENT}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - MONGO_ATLAS_URI=${MONGO_ATLAS_URI}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PACKING_DEPT_WHATSAPP_NUMBER=${PACKING_DEPT_WHATSAPP_NUMBER}
      - REDIS_URL=${REDIS_URL}
      - SESSION_SECRET_KEY=${SESSION_SECRET_KEY}
      - SHOPIFY_ACCESS_TOKEN=${SHOPIFY_ACCESS_TOKEN}
      - SHOPIFY_STOREFRONT_ACCESS_TOKEN=${SHOPIFY_STOREFRONT_ACCESS_TOKEN}
      - SHOPIFY_STORE_URL=${SHOPIFY_STORE_URL}
      - SHOPIFY_WEBHOOK_SECRET=${SHOPIFY_WEBHOOK_SECRET}
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
      - WHATSAPP_APP_SECRET=${WHATSAPP_APP_SECRET}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - WHATSAPP_CATALOG_ID=${WHATSAPP_CATALOG_ID}
      - WHATSAPP_PHONE_ID=${WHATSAPP_PHONE_ID}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN}
      - WHATSAPP_WEBHOOK_SECRET=${WHATSAPP_WEBHOOK_SECRET}
      - GOLDEN_WHATSAPP_ACCESS_TOKEN=${GOLDEN_WHATSAPP_ACCESS_TOKEN}
      - GOLDEN_WHATSAPP_APP_SECRET=${GOLDEN_WHATSAPP_APP_SECRET}
      - GOLDEN_WHATSAPP_BUSINESS_ACCOUNT_ID=${GOLDEN_WHATSAPP_BUSINESS_ACCOUNT_ID}
      - GOLDEN_WHATSAPP_CATALOG_ID=${GOLDEN_WHATSAPP_CATALOG_ID}
      - GOLDEN_WHATSAPP_PHONE_ID=${GOLDEN_WHATSAPP_PHONE_ID}
      - GOLDEN_SHOPIFY_STORE_URL=${GOLDEN_SHOPIFY_STORE_URL}
      - GOLDEN_SHOPIFY_ACCESS_TOKEN=${GOLDEN_SHOPIFY_ACCESS_TOKEN}
      - GOLDEN_SHOPIFY_STOREFRONT_ACCESS_TOKEN=${GOLDEN_SHOPIFY_STOREFRONT_ACCESS_TOKEN}

  # 2. Dedicated scheduler service for background and periodic tasks
  scheduler:
    image: ${DOCKERHUB_USERNAME}/feelori-backend:${IMAGE_TAG:-latest}
    container_name: feelori_scheduler
    restart: unless-stopped
    command: python scheduler.py
    depends_on:
      - redis
    networks:
      - feelori-net
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - API_KEY=${API_KEY}
      #- CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - ENVIRONMENT=${ENVIRONMENT}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - MONGO_ATLAS_URI=${MONGO_ATLAS_URI}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PACKING_DEPT_WHATSAPP_NUMBER=${PACKING_DEPT_WHATSAPP_NUMBER}
      - REDIS_URL=${REDIS_URL}
      - SESSION_SECRET_KEY=${SESSION_SECRET_KEY}
      - SHOPIFY_ACCESS_TOKEN=${SHOPIFY_ACCESS_TOKEN}
      - SHOPIFY_STOREFRONT_ACCESS_TOKEN=${SHOPIFY_STOREFRONT_ACCESS_TOKEN}
      - SHOPIFY_STORE_URL=${SHOPIFY_STORE_URL}
      - SHOPIFY_WEBHOOK_SECRET=${SHOPIFY_WEBHOOK_SECRET}
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
      - WHATSAPP_APP_SECRET=${WHATSAPP_APP_SECRET}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - WHATSAPP_CATALOG_ID=${WHATSAPP_CATALOG_ID}
      - WHATSAPP_PHONE_ID=${WHATSAPP_PHONE_ID}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN}
      - WHATSAPP_WEBHOOK_SECRET=${WHATSAPP_WEBHOOK_SECRET}
      - GOLDEN_WHATSAPP_ACCESS_TOKEN=${GOLDEN_WHATSAPP_ACCESS_TOKEN}
      - GOLDEN_WHATSAPP_APP_SECRET=${GOLDEN_WHATSAPP_APP_SECRET}
      - GOLDEN_WHATSAPP_BUSINESS_ACCOUNT_ID=${GOLDEN_WHATSAPP_BUSINESS_ACCOUNT_ID}
      - GOLDEN_WHATSAPP_CATALOG_ID=${GOLDEN_WHATSAPP_CATALOG_ID}
      - GOLDEN_WHATSAPP_PHONE_ID=${GOLDEN_WHATSAPP_PHONE_ID}
      - GOLDEN_SHOPIFY_STORE_URL=${GOLDEN_SHOPIFY_STORE_URL}
      - GOLDEN_SHOPIFY_ACCESS_TOKEN=${GOLDEN_SHOPIFY_ACCESS_TOKEN}
      - GOLDEN_SHOPIFY_STOREFRONT_ACCESS_TOKEN=${GOLDEN_SHOPIFY_STOREFRONT_ACCESS_TOKEN}

  # 3. WhatsApp Sender Worker - Reliably delivers outbound messages
  whatsapp_worker:
    image: ${DOCKERHUB_USERNAME}/feelori-backend:${IMAGE_TAG:-latest}
    container_name: feelori_whatsapp_worker
    restart: unless-stopped
    command: python -m app.workers.whatsapp_sender
    depends_on:
      - backend
      - redis
    networks:
      - feelori-net
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - API_KEY=${API_KEY}
      #- CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - ENVIRONMENT=${ENVIRONMENT}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - MONGO_ATLAS_URI=${MONGO_ATLAS_URI}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PACKING_DEPT_WHATSAPP_NUMBER=${PACKING_DEPT_WHATSAPP_NUMBER}
      - REDIS_URL=${REDIS_URL}
      - SESSION_SECRET_KEY=${SESSION_SECRET_KEY}
      - SHOPIFY_ACCESS_TOKEN=${SHOPIFY_ACCESS_TOKEN}
      - SHOPIFY_STOREFRONT_ACCESS_TOKEN=${SHOPIFY_STOREFRONT_ACCESS_TOKEN}
      - SHOPIFY_STORE_URL=${SHOPIFY_STORE_URL}
      - SHOPIFY_WEBHOOK_SECRET=${SHOPIFY_WEBHOOK_SECRET}
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
      - WHATSAPP_APP_SECRET=${WHATSAPP_APP_SECRET}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - WHATSAPP_CATALOG_ID=${WHATSAPP_CATALOG_ID}
      - WHATSAPP_PHONE_ID=${WHATSAPP_PHONE_ID}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN}
      - WHATSAPP_WEBHOOK_SECRET=${WHATSAPP_WEBHOOK_SECRET}
      - GOLDEN_WHATSAPP_ACCESS_TOKEN=${GOLDEN_WHATSAPP_ACCESS_TOKEN}
      - GOLDEN_WHATSAPP_APP_SECRET=${GOLDEN_WHATSAPP_APP_SECRET}
      - GOLDEN_WHATSAPP_BUSINESS_ACCOUNT_ID=${GOLDEN_WHATSAPP_BUSINESS_ACCOUNT_ID}
      - GOLDEN_WHATSAPP_CATALOG_ID=${GOLDEN_WHATSAPP_CATALOG_ID}
      - GOLDEN_WHATSAPP_PHONE_ID=${GOLDEN_WHATSAPP_PHONE_ID}
      - GOLDEN_SHOPIFY_STORE_URL=${GOLDEN_SHOPIFY_STORE_URL}
      - GOLDEN_SHOPIFY_ACCESS_TOKEN=${GOLDEN_SHOPIFY_ACCESS_TOKEN}
      - GOLDEN_SHOPIFY_STOREFRONT_ACCESS_TOKEN=${GOLDEN_SHOPIFY_STOREFRONT_ACCESS_TOKEN}

  # 4. AI Responder Worker - Safely generates and enqueues AI responses
  ai_worker:
    image: ${DOCKERHUB_USERNAME}/feelori-backend:${IMAGE_TAG:-latest}
    container_name: feelori_ai_worker
    restart: unless-stopped
    command: python -m app.workers.ai_responder
    depends_on:
      - backend
    networks:
      - feelori-net
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}
      - API_KEY=${API_KEY}
      #- CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - ENVIRONMENT=${ENVIRONMENT}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - MONGO_ATLAS_URI=${MONGO_ATLAS_URI}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - PACKING_DEPT_WHATSAPP_NUMBER=${PACKING_DEPT_WHATSAPP_NUMBER}
      - REDIS_URL=${REDIS_URL}
      - SESSION_SECRET_KEY=${SESSION_SECRET_KEY}
      - SHOPIFY_ACCESS_TOKEN=${SHOPIFY_ACCESS_TOKEN}
      - SHOPIFY_STOREFRONT_ACCESS_TOKEN=${SHOPIFY_STOREFRONT_ACCESS_TOKEN}
      - SHOPIFY_STORE_URL=${SHOPIFY_STORE_URL}
      - SHOPIFY_WEBHOOK_SECRET=${SHOPIFY_WEBHOOK_SECRET}
      - WHATSAPP_ACCESS_TOKEN=${WHATSAPP_ACCESS_TOKEN}
      - WHATSAPP_APP_SECRET=${WHATSAPP_APP_SECRET}
      - WHATSAPP_BUSINESS_ACCOUNT_ID=${WHATSAPP_BUSINESS_ACCOUNT_ID}
      - WHATSAPP_CATALOG_ID=${WHATSAPP_CATALOG_ID}
      - WHATSAPP_PHONE_ID=${WHATSAPP_PHONE_ID}
      - WHATSAPP_VERIFY_TOKEN=${WHATSAPP_VERIFY_TOKEN}
      - WHATSAPP_WEBHOOK_SECRET=${WHATSAPP_WEBHOOK_SECRET}
      - GOLDEN_WHATSAPP_ACCESS_TOKEN=${GOLDEN_WHATSAPP_ACCESS_TOKEN}
      - GOLDEN_WHATSAPP_APP_SECRET=${GOLDEN_WHATSAPP_APP_SECRET}
      - GOLDEN_WHATSAPP_BUSINESS_ACCOUNT_ID=${GOLDEN_WHATSAPP_BUSINESS_ACCOUNT_ID}
      - GOLDEN_WHATSAPP_CATALOG_ID=${GOLDEN_WHATSAPP_CATALOG_ID}
      - GOLDEN_WHATSAPP_PHONE_ID=${GOLDEN_WHATSAPP_PHONE_ID}
      - GOLDEN_SHOPIFY_STORE_URL=${GOLDEN_SHOPIFY_STORE_URL}
      - GOLDEN_SHOPIFY_ACCESS_TOKEN=${GOLDEN_SHOPIFY_ACCESS_TOKEN}
      - GOLDEN_SHOPIFY_STOREFRONT_ACCESS_TOKEN=${GOLDEN_SHOPIFY_STOREFRONT_ACCESS_TOKEN}

  # 5. (Optional) ML worker â€“ disabled to save memory
  # To re-enable, uncomment the lines below
  # ml_worker:
  #   image: ${DOCKERHUB_USERNAME}/feelori-backend:${IMAGE_TAG:-latest}
  #   container_name: feelori_ml_worker
  #   restart: unless-stopped
  #   command: python ml_worker.py
  #   depends_on:
  #     - redis
  #   networks:
  #     - feelori-net
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 4G

  # 6. Redis service for caching and queuing
  redis:
    image: "redis:7-alpine"
    container_name: feelori_redis
    restart: unless-stopped
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - feelori-net

# Persistent Redis data
volumes:
  redis-data:

# Shared network
networks:
  feelori-net:
